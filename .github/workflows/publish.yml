name: Publish to pub.dev

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no actual publish)'
        required: false
        default: 'false'
        type: boolean

  # Trigger on release
  release:
    types: [published]

jobs:
  publish:
    name: Publish packages
    runs-on: ubuntu-latest
    permissions:
      id-token: write # Required for pub.dev authentication
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for melos versioning

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.0'
          channel: 'stable'
          cache: true

      - name: Install Melos
        run: dart pub global activate melos

      - name: Bootstrap
        run: melos bootstrap

      - name: Analyze before publish
        run: melos run analyze

      - name: Run tests before publish
        run: melos run test_all

      - name: Setup pub.dev credentials
        run: |
          mkdir -p $HOME/.config/dart
          echo '${{ secrets.PUB_CREDENTIALS }}' > $HOME/.config/dart/pub-credentials.json

      - name: Publish (dry run)
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: melos publish --dry-run

      - name: Publish
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: melos publish --no-dry-run --yes
